<%- include('partials/head', { title: 'Dashboard' }) %>

<div class="max-w-6xl mx-auto p-6">

    <!-- Header -->
    <div class="flex items-center justify-between mb-10">
        <div>
            <h2 class="text-3xl font-bold tracking-wide text-white">Hello, <%= username %> ðŸ‘‹</h2>
            <p class="text-gray-400 mt-1">Manage your personal movie collection.</p>
        </div>

        <div class="flex gap-3">
            <a href="/profile"
               class="px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 hover:bg-gray-700 transition">
               Edit Profile
            </a>

            <a href="/logout"
               class="px-4 py-2 rounded-lg bg-red-700 border border-red-600 hover:bg-red-800 transition">
               Logout
            </a>
        </div>
    </div>


    <!-- Add Movie -->
    <div class="bg-gray-900 p-6 rounded-2xl shadow-xl border border-gray-800 mb-12">
        <h3 class="text-xl font-semibold mb-4 text-white">Add a New Movie</h3>

        <form id="addMovieForm" class="flex flex-col md:flex-row gap-4">
            <input name="title" placeholder="Movie title" required
                class="flex-1 p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-2 focus:ring-gray-500" />

            <select name="category" required
                class="p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-2 focus:ring-gray-500">
                <option value="watched">Watched</option>
                <option value="watching">Watching</option>
                <option value="want">Want to watch</option>
            </select>

            <button type="submit"
                class="px-6 py-3 rounded-lg bg-gradient-to-r from-gray-700 to-gray-600 text-white font-medium hover:opacity-90 transition">
                Add Movie
            </button>
        </form>
    </div>


    <!-- Movie Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">

        <% if (movies.length === 0) { %>
            <div class="col-span-3 text-center text-gray-400 p-6 bg-gray-900 rounded-xl border border-gray-800">
                No movies yet. Start by adding one above.
            </div>
        <% } %>

        <% movies.forEach(movie => { %>
            <div class="bg-gray-900 p-5 rounded-2xl shadow-md border border-gray-800 hover:border-gray-700 transition">

                <h3 class="text-lg font-semibold text-white mb-1"><%= movie.title %></h3>
                <p class="text-sm text-gray-400 mb-4">
                    Category:
                    <span class="text-gray-200 font-medium"><%= movie.category %></span>
                </p>

                <div class="flex justify-between mt-4">
                    <button class="editBtn px-4 py-2 rounded-lg border border-gray-600 text-gray-300 
                                 hover:bg-gray-800 transition font-medium"
                            data-id="<%= movie._id %>"
                            data-title="<%= movie.title %>"
                            data-category="<%= movie.category %>">
                        Edit
                    </button>

                    <button class="deleteBtn px-4 py-2 rounded-lg border border-red-600 text-red-400 
                                   hover:bg-red-900 transition font-medium"
                            data-id="<%= movie._id %>">
                        Delete
                    </button>
                </div>

            </div>
        <% }) %>

    </div>
</div>



<!-- EDIT MODAL -->
<div id="editModal"
     class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center">
    <div class="bg-gray-900 w-full max-w-md p-6 rounded-2xl border border-gray-700">

        <h2 class="text-xl font-semibold text-white mb-4">Edit Movie</h2>

        <form id="editMovieForm" class="flex flex-col gap-4">
            <input id="editTitle" name="title"
                   class="p-3 rounded-lg bg-gray-800 text-white border border-gray-700" />

            <select id="editCategory" name="category"
                    class="p-3 rounded-lg bg-gray-800 text-white border border-gray-700">
                <option value="watched">Watched</option>
                <option value="watching">Watching</option>
                <option value="want">Want to watch</option>
            </select>

            <input type="hidden" id="editId">

            <div class="flex justify-end gap-3 mt-4">
                <button type="button" id="cancelEdit"
                        class="px-4 py-2 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-700">
                    Cancel
                </button>

                <button type="submit"
                        class="px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600">
                    Save
                </button>
            </div>
        </form>

    </div>
</div>



<script>

/* ------------------ ADD MOVIE ------------------ */
document.getElementById("addMovieForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const body = Object.fromEntries(fd.entries());

    const res = await fetch("/movies", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    if (res.ok) location.reload();
});


/* ------------------ DELETE MOVIE ------------------ */
document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        if (!confirm("Delete this movie?")) return;

        await fetch(`/movies/${id}`, { method: "DELETE" });
        location.reload();
    });
});


/* ------------------ EDIT MOVIE (MODAL) ------------------ */
const modal = document.getElementById("editModal");
const editForm = document.getElementById("editMovieForm");
const editTitle = document.getElementById("editTitle");
const editCategory = document.getElementById("editCategory");
const editId = document.getElementById("editId");

document.querySelectorAll(".editBtn").forEach(btn => {
    btn.addEventListener("click", () => {
        modal.classList.remove("hidden");

        editTitle.value = btn.dataset.title;
        editCategory.value = btn.dataset.category;
        editId.value = btn.dataset.id;
    });
});

document.getElementById("cancelEdit").addEventListener("click", () => {
    modal.classList.add("hidden");
});

/* SUBMIT EDIT */
editForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = editId.value;

    const res = await fetch(`/movies/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            title: editTitle.value,
            category: editCategory.value
        })
    });

    if (res.ok) location.reload();
});

</script>

<%- include('partials/footer') %>
